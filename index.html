<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Rider Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Phantom + Robinhood Style -->
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #3f2b96 0, #00010a 55%, #050816 100%);
      color: #f5f5f5;
      display: flex;
      justify-content: center;
      padding: 16px;
    }
    .app-container {
      max-width: 520px;
      width: 100%;
      background: linear-gradient(160deg, rgba(255,199,95,0.22), rgba(55,0,120,0.85));
      border-radius: 28px;
      padding: 2px;
      box-shadow: 0 0 40px rgba(0,0,0,0.85);
    }
    .app-inner {
      background: #060919;
      border-radius: 26px;
      padding: 16px;
    }
    h1 {
      margin: 4px 0 12px 0;
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.03em;
    }
    h2 {
      margin: 0 0 10px 0;
      font-size: 1.05rem;
    }
    .card {
      background: #11152f;
      border-radius: 18px;
      padding: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.04);
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.9rem;
      opacity: 0.9;
    }
    input[type="number"],
    input[type="date"],
    select {
      width: 100%;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #d0d3e6;
      background: #ffffff;         /* ช่องกรอก & วันที่เป็นสีขาว */
      color: #11152b;              /* ตัวหนังสือเข้มอ่านง่าย */
      font-size: 0.9rem;
    }
    input[type="number"]:focus,
    input[type="date"]:focus,
    select:focus {
      outline: 2px solid #ffb347;
      border-color: transparent;
    }
    button {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 8px;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }
    button:active {
      transform: scale(0.97);
      box-shadow: 0 0 10px rgba(0,0,0,0.4) inset;
    }
    .btn-primary {
      background: linear-gradient(135deg, #ffb347, #ff6b6b);
      color: #11152b;
      font-weight: 600;
    }
    .btn-secondary {
      background: #22274a;
      color: #f5f5f5;
    }
    .small {
      font-size: 0.8rem;
      opacity: 0.85;
    }
    .row {
      display: flex;
      gap: 8px;
    }
    .row > div {
      flex: 1;
    }
    #login-section {
      text-align: center;
      margin-top: 40px;
    }
    .status {
      font-size: 0.85rem;
      margin-top: 4px;
      min-height: 18px;
    }
    /* nav tab สลับหน้า */
    .nav-card {
      display: flex;
      gap: 8px;
      padding: 6px;
      background: #0b0f25;
    }
    .tab-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 8px 4px;
      font-size: 0.9rem;
      cursor: pointer;
      background: transparent;
      color: #c5c8ff;
    }
    .tab-active {
      background: radial-gradient(circle at top left, #ffd36f, #ff6b9c);
      color: #11152b;
      font-weight: 600;
    }
    /* rank cards */
    .rank-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .rank-card {
      border-radius: 14px;
      padding: 6px 6px 8px 6px;
      text-align: center;
      color: #11152b;
      font-size: 0.8rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    .rank-hero {
      background: linear-gradient(145deg, #ffecd2, #fcb69f);
    }
    .rank-knight {
      background: linear-gradient(145deg, #d4fc79, #96e6a1);
    }
    .rank-lord {
      background: linear-gradient(145deg, #a18cd1, #fbc2eb);
    }
    .rank-title {
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 2px;
    }
    .pill-buttons {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    .pill-buttons button {
      flex: 1;
      padding: 6px 4px;
      font-size: 0.8rem;
      border-radius: 999px;
    }
    .pill-active {
      outline: 2px solid #f7b267;
    }
    canvas {
      background: #050818;
      border-radius: 10px;
      padding: 4px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="app-inner">
      <h1>Rider Tracker</h1>

      <!-- ส่วนล็อกอิน -->
      <div id="login-section">
        <p class="small">กรุณาเข้าสู่ระบบด้วย Google เพื่อบันทึกและดูสถิติของคุณ</p>
        <button id="btn-login" class="btn-primary">Sign in with Google</button>
      </div>

      <!-- ส่วนแอปหลังล็อกอิน -->
      <div id="app-section" style="display:none;">

        <div class="card">
          <div class="row" style="align-items:center;">
            <div>
              <div class="small">เข้าสู่ระบบเป็น</div>
              <div id="user-email"></div>
            </div>
            <div style="text-align:right;">
              <button id="btn-logout" class="btn-secondary" style="width:auto;padding:6px 12px;font-size:0.8rem;">ออกจากระบบ</button>
            </div>
          </div>
        </div>

        <!-- แถบสลับหน้า -->
        <div class="card nav-card">
          <button id="tab-today" class="tab-btn tab-active">บันทึก/แก้ไขรายวัน</button>
          <button id="tab-summary" class="tab-btn">สรุปยอด</button>
        </div>

        <!-- TODAY SECTION -->
        <div id="today-section">
          <div class="card">
            <h2>บันทึกข้อมูลรายวัน</h2>

            <label>เลือกวันที่ที่ต้องการบันทึกหรือแก้ไข</label>
            <input type="date" id="date-input">
            <div class="small" id="today-text" style="margin-top:4px;"></div>

            <label style="margin-top:8px;">จำนวนงานสำเร็จ (ออเดอร์)</label>
            <input type="number" id="orders-input" min="0" step="1">

            <div class="row" style="margin-top:6px;">
              <div>
                <label>รายได้รายวัน (00:00 - 24:00)</label>
                <input type="number" id="daily-income-input" min="0" step="0.01">
              </div>
              <div>
                <label>ยอดตัดรอบ 18:00</label>
                <input type="number" id="cutoff-income-input" min="0" step="0.01">
              </div>
            </div>

            <button id="btn-save" class="btn-primary" style="margin-top:10px;">บันทึกข้อมูลวันที่นี้</button>
            <div id="save-status" class="status"></div>
          </div>

          <div class="card">
            <h2>สรุปออเดอร์เดือนนี้</h2>
            <div class="small" id="month-info"></div>
            <div class="small">ออเดอร์สำเร็จเดือนนี้: <span id="month-orders">0</span> งาน</div>

            <div class="small" style="margin-top:6px;">
              เกณฑ์แร้งก์โหลดจาก <code>appConfig/ranks</code> ใน Firestore (แก้ไขได้ตามใจผู้พัฒนา)
            </div>

            <div class="rank-grid">
              <div class="rank-card rank-hero">
                <div class="rank-title">Hero</div>
                <div class="small" id="hero-target"></div>
                <div class="small" id="hero-remaining"></div>
                <div class="small" id="hero-daily"></div>
              </div>
              <div class="rank-card rank-knight">
                <div class="rank-title">Knight</div>
                <div class="small" id="knight-target"></div>
                <div class="small" id="knight-remaining"></div>
                <div class="small" id="knight-daily"></div>
              </div>
              <div class="rank-card rank-lord">
                <div class="rank-title">Lord</div>
                <div class="small" id="lord-target"></div>
                <div class="small" id="lord-remaining"></div>
                <div class="small" id="lord-daily"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- SUMMARY SECTION -->
        <div id="summary-section" style="display:none;">
          <div class="card">
            <h2>สรุปยอด & กราฟ</h2>
            <div class="small">เลือกช่วงเวลา + ประเภทข้อมูลที่ต้องการดู</div>

            <label style="margin-top:8px;">ประเภทข้อมูล</label>
            <select id="summary-metric">
              <option value="dailyIncome">รายได้รายวัน (00:00 - 24:00)</option>
              <option value="cutoffIncome">ยอดตัดรอบ 18:00</option>
              <option value="ordersCompleted">จำนวนออเดอร์สำเร็จ</option>
            </select>

            <div class="pill-buttons">
              <button class="btn-secondary" data-range="week" id="btn-range-week">สัปดาห์นี้</button>
              <button class="btn-secondary pill-active" data-range="month" id="btn-range-month">เดือนนี้</button>
              <button class="btn-secondary" data-range="year" id="btn-range-year">ปีนี้</button>
            </div>

            <div class="row" style="margin-top:8px;">
              <div>
                <label>เริ่มจากวันที่ (Custom)</label>
                <input type="date" id="summary-start">
              </div>
              <div>
                <label>ถึงวันที่</label>
                <input type="date" id="summary-end">
              </div>
            </div>
            <button id="btn-summary-apply" class="btn-secondary" style="margin-top:8px;">ใช้ช่วงวันที่ Custom</button>

            <div class="card" style="margin-top:10px;background:#0c1026;">
              <div class="small">สรุปรายได้เดือนนี้ (ถึงวันที่บันทึกล่าสุด)</div>
              <div class="small" id="month-summary-text"></div>
            </div>

            <div style="margin-top:8px;height:220px;">
              <canvas id="summary-chart"></canvas>
            </div>

            <div class="small" id="summary-stats" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js สำหรับกราฟแท่ง -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ===== ใส่ config ของโปรเจกต์คุณตรงนี้ =====
    const firebaseConfig = {
  apiKey: "AIzaSyCBlaCeUMRlM0o06tTyW_yhnmny5UgLbX4",
  authDomain: "robinhood-rider-tracker.firebaseapp.com",
  projectId: "robinhood-rider-tracker",
  storageBucket: "robinhood-rider-tracker.firebasestorage.app",
  messagingSenderId: "1008383195308",
  appId: "1:1008383195308:web:c612dcbc6a34be00de4709",
  measurementId: "G-0LZ925S6J8"
    };
    // ======================================

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const DEFAULT_RANKS = { hero: 100, knight: 150, lord: 350 };

    let cachedRecords = [];
    let summaryChart = null;
    let currentRangeType = "month";

    // ===== helpers ทั่วไป =====
    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }
    function getMonthKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }
    function formatThaiDate(date) {
      return date.toLocaleDateString("th-TH", {
        year: "numeric",
        month: "long",
        day: "numeric",
        weekday: "short"
      });
    }

    async function loadRankConfig() {
      try {
        const snap = await db.collection("appConfig").doc("ranks").get();
        if (snap.exists) return { ...DEFAULT_RANKS, ...snap.data() };
      } catch (e) {
        console.log("โหลด rank config ไม่สำเร็จ ใช้ default แทน", e);
      }
      return DEFAULT_RANKS;
    }

    async function loadRecord(uid, dateKey) {
      const ref = db.collection("users").doc(uid)
                    .collection("dailyRecords").doc(dateKey);
      const snap = await ref.get();
      return snap.exists ? snap.data() : null;
    }

    async function saveRecord(uid, dateKey, payload) {
      const d = new Date(dateKey);
      const monthKey = getMonthKey(d);
      const ref = db.collection("users").doc(uid)
                    .collection("dailyRecords").doc(dateKey);
      await ref.set({
        date: dateKey,
        month: monthKey,
        ...payload,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    async function loadMonthOrders(uid, monthKey) {
      const col = db.collection("users").doc(uid).collection("dailyRecords");
      const snap = await col.where("month", "==", monthKey).get();
      let total = 0;
      snap.forEach(doc => total += Number(doc.data().ordersCompleted || 0));
      return total;
    }

    async function loadAllRecords(uid) {
      const col = db.collection("users").doc(uid).collection("dailyRecords");
      const snap = await col.get();
      const records = [];
      snap.forEach(doc => {
        const data = doc.data();
        if (!data.date) return;
        const [y, m, d] = data.date.split("-").map(Number);
        const dateObj = new Date(y, m - 1, d);
        records.push({
          dateKey: data.date,
          dateObj,
          month: data.month || getMonthKey(dateObj),
          ordersCompleted: Number(data.ordersCompleted || 0),
          dailyIncome: Number(data.dailyIncome || 0),
          cutoffIncome: Number(data.cutoffIncome || 0)
        });
      });
      records.sort((a, b) => a.dateObj - b.dateObj);
      cachedRecords = records;
      return records;
    }

    // ===== Rank cards (รวมเป้าหมายเฉลี่ยต่อวัน) =====
    function renderRankCards(ranks, monthOrders) {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();              // 0 = ม.ค.
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const todayDay = today.getDate();
      let daysLeft = daysInMonth - todayDay + 1;   // รวมวันนี้
      if (daysLeft < 1) daysLeft = 1;

      function fillRank(prefix, label, targetRaw) {
        const target = Number(targetRaw || 0);
        const remaining = Math.max(0, target - monthOrders);

        const targetEl  = document.getElementById(prefix + "-target");
        const remainEl  = document.getElementById(prefix + "-remaining");
        const dailyEl   = document.getElementById(prefix + "-daily");
        if (!targetEl || !remainEl || !dailyEl) return;

        targetEl.textContent = `เป้าหมาย: ${target} งาน/เดือน`;

        if (remaining <= 0) {
          const over = monthOrders - target;
          remainEl.textContent = `คุณถึงระดับ ${label} แล้ว! (ออเดอร์สะสม: ${monthOrders} งาน)`;
          if (over > 0) {
            dailyEl.textContent = `เกินเป้าแล้ว +${over} งาน`;
          } else {
            dailyEl.textContent = `รักษาระดับ ${label} ต่อไปนะ`;
          }
        } else {
          const dailyTarget = Math.ceil(remaining / daysLeft);
          remainEl.textContent = `ขาดอีก: ${remaining} งาน (เหลือ ${daysLeft} วันในเดือนนี้)`;
          dailyEl.textContent  = `เป้าหมายเฉลี่ยต่อวัน: ${dailyTarget} งาน/วัน`;
        }
      }

      fillRank("hero",   "Hero",   ranks.hero);
      fillRank("knight", "Knight", ranks.knight);
      fillRank("lord",   "Lord",   ranks.lord);
    }

    // ===== Summary helpers =====
    function getRange(type, customStartStr, customEndStr) {
      const now = new Date();
      let start, end;

      if (type === "week") {
        const day = now.getDay(); // 0=อาทิตย์ ... 6=เสาร์
        const offsetToMonday = (day + 6) % 7;
        start = new Date(now);
        start.setDate(now.getDate() - offsetToMonday);
        end = new Date(start);
        end.setDate(start.getDate() + 6);
      } else if (type === "month") {
        start = new Date(now.getFullYear(), now.getMonth(), 1);
        end   = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      } else if (type === "year") {
        start = new Date(now.getFullYear(), 0, 1);
        end   = new Date(now.getFullYear(), 11, 31);
      } else if (type === "custom") {
        if (!customStartStr || !customEndStr) return null;
        start = new Date(customStartStr);
        end   = new Date(customEndStr);
      } else {
        return null;
      }

      start.setHours(0,0,0,0);
      end.setHours(23,59,59,999);
      return { start, end };
    }

    function buildDailySeries(rangeStart, rangeEnd, metric) {
      const series = [];
      if (!cachedRecords.length) return series;

      const map = {};
      cachedRecords.forEach(r => map[r.dateKey] = r);

      const d = new Date(rangeStart);
      while (d <= rangeEnd) {
        const dateKey = formatDateKey(d);
        const rec = map[dateKey];
        series.push({
          dateKey,
          dateObj: new Date(d),
          value: rec ? Number(rec[metric] || 0) : 0,
          ordersCompleted: rec ? Number(rec.ordersCompleted || 0) : 0
        });
        d.setDate(d.getDate() + 1);
      }
      return series;
    }

    function buildSummaryStats(series) {
      let totalMetric = 0;
      let totalOrders = 0;
      series.forEach(s => {
        totalMetric += s.value;
        totalOrders += s.ordersCompleted;
      });
      const days = series.length;
      const avgMetric = days ? totalMetric / days : 0;
      return { totalMetric, totalOrders, days, avgMetric };
    }

    function computeMonthToDateSummary() {
      if (!cachedRecords.length) return null;
      const now = new Date();
      const monthKey = getMonthKey(now);
      const list = cachedRecords.filter(r => r.month === monthKey);
      if (!list.length) return null;

      let sumDaily = 0, sumCutoff = 0, sumOrders = 0;
      list.forEach(r => {
        sumDaily  += r.dailyIncome || 0;
        sumCutoff += r.cutoffIncome || 0;
        sumOrders += r.ordersCompleted || 0;
      });
      return {
        monthKey,
        sumDaily,
        sumCutoff,
        sumOrders,
        days: list.length,
        lastDate: list[list.length - 1].dateObj
      };
    }

    function renderMonthSummaryBox() {
      const info = computeMonthToDateSummary();
      const el = document.getElementById("month-summary-text");
      if (!info) {
        el.textContent = "ยังไม่มีการบันทึกในเดือนนี้";
        return;
      }
      const last = info.lastDate ? formatThaiDate(info.lastDate) : "";
      el.innerHTML =
        `เดือน: ${info.monthKey} | ถึงวันที่: ${last}<br>` +
        `รายได้รวม (00-24): ${info.sumDaily.toFixed(2)} บาท | ` +
        `ยอดตัดรอบรวม: ${info.sumCutoff.toFixed(2)} บาท | ` +
        `ออเดอร์รวม: ${info.sumOrders} งาน`;
    }

    function metricLabel(metric) {
      if (metric === "dailyIncome") return "รายได้รายวัน (00-24)";
      if (metric === "cutoffIncome") return "ยอดตัดรอบ 18:00";
      if (metric === "ordersCompleted") return "จำนวนออเดอร์สำเร็จ";
      return metric;
    }

    function updateSummaryChart(series, metric) {
      const ctx = document.getElementById("summary-chart").getContext("2d");
      const labels = series.map(s => {
        const d = s.dateObj;
        return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}`;
      });
      const dataVals = series.map(s => s.value);

      if (summaryChart) summaryChart.destroy();

      summaryChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: metricLabel(metric),
            data: dataVals
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: "#c5c8ff", font: { size: 10 } }
            },
            y: {
              ticks: { color: "#c5c8ff" }
            }
          },
          plugins: {
            legend: {
              labels: { color: "#f5f5f5" }
            }
          }
        }
      });
    }

    function renderSummaryStats(stats, metric, series) {
      const el = document.getElementById("summary-stats");
      if (!series.length) {
        el.textContent = "ยังไม่มีข้อมูลในช่วงเวลาที่เลือก";
        return;
      }
      const unit = metric === "ordersCompleted" ? "งาน" : "บาท";
      el.innerHTML =
        `จำนวนวันในช่วง: ${stats.days} วัน | ` +
        `ยอดรวม: ${stats.totalMetric.toFixed(2)} ${unit} | ` +
        `เฉลี่ยต่อวัน: ${stats.avgMetric.toFixed(2)} ${unit} | ` +
        `ออเดอร์รวม: ${stats.totalOrders} งาน`;
    }

    function highlightRangeButton(activeId) {
      ["btn-range-week", "btn-range-month", "btn-range-year"].forEach(id => {
        const btn = document.getElementById(id);
        if (!btn) return;
        btn.classList.toggle("pill-active", id === activeId);
      });
    }

    function applySummary(rangeType) {
      currentRangeType = rangeType;
      const metric = document.getElementById("summary-metric").value;
      const startStr = document.getElementById("summary-start").value;
      const endStr   = document.getElementById("summary-end").value;

      const range = getRange(rangeType, startStr, endStr);
      if (!range) {
        updateSummaryChart([], metric);
        renderSummaryStats({totalMetric:0,totalOrders:0,days:0,avgMetric:0}, metric, []);
        return;
      }

      if (rangeType !== "custom") {
        document.getElementById("summary-start").value = formatDateKey(range.start);
        document.getElementById("summary-end").value   = formatDateKey(range.end);
      }

      const series = buildDailySeries(range.start, range.end, metric);
      updateSummaryChart(series, metric);
      const stats = buildSummaryStats(series);
      renderSummaryStats(stats, metric, series);
      renderMonthSummaryBox();
    }

    // ===== UI logic =====
    const loginSection  = document.getElementById("login-section");
    const appSection    = document.getElementById("app-section");
    const userEmailEl   = document.getElementById("user-email");
    const todayTextEl   = document.getElementById("today-text");
    const monthInfoEl   = document.getElementById("month-info");
    const monthOrdersEl = document.getElementById("month-orders");
    const saveStatusEl  = document.getElementById("save-status");

    const dateInput          = document.getElementById("date-input");
    const ordersInput        = document.getElementById("orders-input");
    const dailyIncomeInput   = document.getElementById("daily-income-input");
    const cutoffIncomeInput  = document.getElementById("cutoff-income-input");

    const todaySection   = document.getElementById("today-section");
    const summarySection = document.getElementById("summary-section");
    const tabToday       = document.getElementById("tab-today");
    const tabSummary     = document.getElementById("tab-summary");

    document.getElementById("btn-login").addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => alert("ล็อกอินไม่สำเร็จ: " + err.message));
    });

    document.getElementById("btn-logout").addEventListener("click", () => auth.signOut());

    document.getElementById("btn-save").addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;

      let dateKey = dateInput.value;
      if (!dateKey) {
        const today = new Date();
        dateKey = formatDateKey(today);
        dateInput.value = dateKey;
      }

      const payload = {
        ordersCompleted: Number(ordersInput.value || 0),
        dailyIncome: Number(dailyIncomeInput.value || 0),
        cutoffIncome: Number(cutoffIncomeInput.value || 0)
      };

      saveStatusEl.textContent = "กำลังบันทึก...";
      try {
        await saveRecord(user.uid, dateKey, payload);
        saveStatusEl.textContent = "บันทึกสำเร็จ ✅";
        await refreshMonthSummary(user);
        await loadAllRecords(user.uid);
        applySummary(currentRangeType);
      } catch (e) {
        console.error(e);
        saveStatusEl.textContent = "บันทึกไม่สำเร็จ: " + e.message;
      }
    });

    dateInput.addEventListener("change", async () => {
      const user = auth.currentUser;
      if (!user) return;
      await loadFormForSelectedDate(user);
    });

    tabToday.addEventListener("click", () => {
      tabToday.classList.add("tab-active");
      tabSummary.classList.remove("tab-active");
      todaySection.style.display = "block";
      summarySection.style.display = "none";
    });

    tabSummary.addEventListener("click", async () => {
      tabSummary.classList.add("tab-active");
      tabToday.classList.remove("tab-active");
      todaySection.style.display = "none";
      summarySection.style.display = "block";

      const user = auth.currentUser;
      if (!user) return;
      if (!cachedRecords.length) await loadAllRecords(user.uid);
      highlightRangeButton("btn-range-month");
      applySummary("month");
    });

    document.getElementById("summary-metric").addEventListener("change", () => {
      applySummary(currentRangeType);
    });

    document.getElementById("btn-range-week").addEventListener("click", () => {
      highlightRangeButton("btn-range-week");
      applySummary("week");
    });
    document.getElementById("btn-range-month").addEventListener("click", () => {
      highlightRangeButton("btn-range-month");
      applySummary("month");
    });
    document.getElementById("btn-range-year").addEventListener("click", () => {
      highlightRangeButton("btn-range-year");
      applySummary("year");
    });

    document.getElementById("btn-summary-apply").addEventListener("click", () => {
      currentRangeType = "custom";
      highlightRangeButton(""); 
      applySummary("custom");
    });

    async function loadFormForSelectedDate(user) {
      let dateKey = dateInput.value;
      if (!dateKey) {
        const today = new Date();
        dateKey = formatDateKey(today);
        dateInput.value = dateKey;
      }
      const [y,m,d] = dateKey.split("-").map(Number);
      const dateObj = new Date(y, m-1, d);
      todayTextEl.textContent = `วันที่เลือก: ${formatThaiDate(dateObj)} (ID: ${dateKey})`;

      const data = await loadRecord(user.uid, dateKey);
      if (data) {
        ordersInput.value = data.ordersCompleted ?? "";
        dailyIncomeInput.value = data.dailyIncome ?? "";
        cutoffIncomeInput.value = data.cutoffIncome ?? "";
      } else {
        ordersInput.value = "";
        dailyIncomeInput.value = "";
        cutoffIncomeInput.value = "";
      }
    }

    async function refreshMonthSummary(user) {
      const now = new Date();
      const monthKey = getMonthKey(now);
      monthInfoEl.textContent = `เดือนปัจจุบัน: ${monthKey}`;
      const [ranks, totalOrders] = await Promise.all([
        loadRankConfig(),
        loadMonthOrders(user.uid, monthKey)
      ]);
      monthOrdersEl.textContent = totalOrders;
      renderRankCards(ranks, totalOrders);
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        loginSection.style.display = "none";
        appSection.style.display   = "block";
        userEmailEl.textContent = user.email || user.displayName || user.uid;
        saveStatusEl.textContent = "";

        const today = new Date();
        const todayKey = formatDateKey(today);
        dateInput.value = todayKey;

        await loadFormForSelectedDate(user);
        await refreshMonthSummary(user);
        await loadAllRecords(user.uid);
        renderMonthSummaryBox();
      } else {
        loginSection.style.display = "block";
        appSection.style.display   = "none";
      }
    });
  </script>
</body>
</html>
